name: ğŸš€ Release Build & Deploy

on:
  push:
    tags:
      - 'v*.*.*' # Trigger su tag tipo v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: 'Versione (es: 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ·ï¸ CREATE RELEASE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-release:
    name: ğŸ·ï¸ Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
          body: |
            ## ğŸ¬ Camera 2 FPS App - Release
            
            ### ğŸ“¥ Download:
            - **Android APK**: Vedi assets sotto
            - **iOS**: Build disponibile (richiede firma)
            
            ### âœ¨ Features:
            - Registrazione time-lapse a 2 FPS
            - Selezione risoluzione camera
            - UI minimalista e intuitiva
            
            ### ğŸ“ Changelog:
            - Prima release

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ¤– BUILD & UPLOAD ANDROID
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-release-android:
    name: ğŸ¤– Build Android & Upload to Release
    needs: create-release
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          channel: 'stable'

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build APK
        run: flutter build apk --release --split-per-abi

      - name: ğŸ”¨ Build App Bundle
        run: flutter build appbundle --release

      - name: ğŸ“¤ Upload APK arm64-v8a to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          asset_name: camera-2fps-arm64-v8a.apk
          asset_content_type: application/vnd.android.package-archive

      - name: ğŸ“¤ Upload APK armeabi-v7a to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
          asset_name: camera-2fps-armeabi-v7a.apk
          asset_content_type: application/vnd.android.package-archive

      - name: ğŸ“¤ Upload APK x86_64 to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: build/app/outputs/flutter-apk/app-x86_64-release.apk
          asset_name: camera-2fps-x86_64.apk
          asset_content_type: application/vnd.android.package-archive

      - name: ğŸ“¤ Upload App Bundle to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: build/app/outputs/bundle/release/app-release.aab
          asset_name: camera-2fps-bundle.aab
          asset_content_type: application/octet-stream

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ BUILD iOS (opzionale, commentato per costi)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # build-and-release-ios:
  #   name: ğŸ Build iOS
  #   needs: create-release
  #   runs-on: macos-latest
  #   
  #   steps:
  #     - name: ğŸ“¥ Checkout
  #       uses: actions/checkout@v4
  # 
  #     - name: ğŸ¦ Setup Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: '3.24.3'
  #         channel: 'stable'
  # 
  #     - name: ğŸ“¦ Get dependencies
  #       run: flutter pub get
  # 
  #     - name: ğŸ”¨ Build iOS
  #       run: flutter build ios --release --no-codesign
